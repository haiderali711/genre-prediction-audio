# Which Docker image shall be used on the GitLab runner?
image: docker:latest

# Details about how to connect to the Docker service to run this build.
variables:
  DOCKER_HOST: tcp://localhost:2375
  DOCKER_DRIVER: overlay2
  # Create the certificates inside this directory for both the server
  # and client. The certificates used by the client will be created in
  # /certs/client so we only need to share this directory with the
  # volume mount in `config.toml`.
  DOCKER_TLS_CERTDIR: ""

services:
  - name: docker:19.03.0-dind

stages:
  - test-build
  - build
  - deploy
  # - test

# This section describes what shall be done to build and test the project.
build-feature-branch:
  # Display information before we start the build.
  before_script:
    - docker info
    - docker login -u gitlab-ci-token -p ${CI_BUILD_TOKEN} ${CI_REGISTRY}
  rules:
    - if: $CI_COMMIT_TAG == null
  tags:
    - kubernetes
  stage: test-build
  script:
    - cd genre_classification
    - docker build --pull --no-cache .

# This section describes what shall be done to deploy artefacts from the project.
build-to-registry:
  before_script:
    - docker info
    - docker login -u gitlab-ci-token -p ${CI_BUILD_TOKEN} ${CI_REGISTRY}
  tags:
    - kubernetes
  stage: build
  rules:
    - if: $CI_COMMIT_TAG != null && $CI_COMMIT_TAG =~ /^v\d[.]\d[.]\d$/
  script:
    - cd genre_classification
    - docker build -t ${CI_REGISTRY}/${CI_PROJECT_PATH}:"$CI_COMMIT_TAG" .
    - docker push ${CI_REGISTRY}/${CI_PROJECT_PATH}:"$CI_COMMIT_TAG"

release:
  image: thisiskj/kubectl-envsubst
  stage: deploy
  environment:
    name: default
  rules:
    - if: $CI_COMMIT_TAG != null && $CI_COMMIT_TAG =~ /^v\d[.]\d[.]\d$/
  script:
    - envsubst \$CI_COMMIT_TAG < docker-deployment.yaml > deployment.yaml
    - kubectl apply -f deployment.yaml
